pipeline {
    agent {
        kubernetes {
            yamlFile 'jenkins/podTemplate.yaml'
            defaultContainer 'docker'
        }
    }

    environment {
        DATE_TAG = java.time.LocalDate.now()
    }

    options {
        ansiColor('xterm')
    }

    stages {
               
        stage('Latest') {
            steps {
                sh 'docker build -t registry.anthonyoteri.com/docker-yarn:latest -f Dockerfile .'
            }

            post {
                success {
                    sh "docker push registry.anthonyoteri.com/docker-yarn:latest"

                    sh "docker tag registry.anthonyoteri.com/docker-yarn:latest registry.anthonyoteri.com/docker-yarn:latest-${DATE_TAG}"
                    sh "docker push registry.anthonyoteri.com/docker-yarn:latest-${DATE_TAG}"
                }
            }
        }

        stage('Slim') {
            steps {
                sh 'docker build -t registry.anthonyoteri.com/docker-yarn:slim -f Dockerfile.slim .'
            }
            post {
                success {
                    sh "docker push registry.anthonyoteri.com/docker-yarn:slim"

                    sh "docker tag registry.anthonyoteri.com/docker-yarn:slim registry.anthonyoteri.com/docker-yarn:slim-${DATE_TAG}"
                    sh "docker push registry.anthonyoteri.com/docker-yarn:slim-${DATE_TAG}"
                }
            }
        }
    }
}
